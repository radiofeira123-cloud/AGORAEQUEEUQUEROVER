<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Visualizador de Fotos - Suas Fotos üì∏</title>
  <style>
    body { 
      margin: 0; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white; 
      padding: 20px;
      min-height: 100vh;
      font-family: Arial, sans-serif;
    }
    
    h1 { 
      text-align: center; 
      margin-bottom: 10px; 
      font-size: 2.5rem;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .session-info { 
      background: rgba(255,255,255,0.1); 
      padding: 15px 25px; 
      border-radius: 15px; 
      margin-bottom: 25px; 
      text-align: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .gallery { 
      display: flex; 
      flex-wrap: wrap; 
      justify-content: center; 
      gap: 25px;
      max-width: 1200px;
    }
    
    .photo-container { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      margin: 10px;
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    img { 
      width: 280px; 
      height: 280px;
      object-fit: cover;
      border-radius: 12px; 
      border: 3px solid rgba(255,255,255,0.3);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
    }
    
    img:hover {
      transform: scale(1.05);
    }
    
    .download-btn { 
      padding: 12px 20px; 
      background: linear-gradient(135deg, #28a745, #20c997); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-size: 16px; 
      font-weight: bold;
      margin-top: 12px;
      transition: all 0.3s ease;
    }
    
    .download-btn:hover { 
      background: linear-gradient(135deg, #218838, #1e9e8a);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .download-all-btn { 
      padding: 15px 30px; 
      background: linear-gradient(135deg, #007bff, #0056b3); 
      color: white; 
      border: none; 
      border-radius: 10px; 
      cursor: pointer; 
      font-size: 18px; 
      font-weight: bold; 
      margin-bottom: 30px;
      transition: all 0.3s ease;
    }
    
    .download-all-btn:hover { 
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    
    .expiry-info {
      background: rgba(255,193,7,0.2);
      padding: 10px 20px;
      border-radius: 10px;
      margin: 15px 0;
      border: 1px solid rgba(255,193,7,0.3);
    }
    
    .loading {
      font-size: 1.5rem;
      text-align: center;
      margin: 50px 0;
    }
    
    .no-photos {
      font-size: 1.3rem;
      text-align: center;
      margin: 50px 0;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div class="session-info">
    <h1>üì∏ Suas Fotos</h1>
    <p>Sess√£o: <strong id="viewerIdDisplay">‚Äî</strong></p>
    <div class="expiry-info">
      ‚è∞ Estas fotos ficar√£o dispon√≠veis por 7 dias
    </div>
  </div>

  <button id="downloadAllBtn" class="download-all-btn" style="display:none;">
    üì• Download Todas as Fotos
  </button>

  <div id="gallery" class="gallery">
    <div class="loading">üîÑ Carregando suas fotos...</div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const viewerId = params.get("viewerId");
    const gallery = document.getElementById("gallery");
    const downloadAllBtn = document.getElementById("downloadAllBtn");
    const viewerIdDisplay = document.getElementById("viewerIdDisplay");
    
    const socket = io("https://agoraequeeuquerover.onrender.com");

    // Mostrar viewerId atual
    if (viewerId) {
      viewerIdDisplay.textContent = viewerId;
      
      // Conectar ao visualizador
      socket.emit("join_viewer", { viewerId });
    } else {
      gallery.innerHTML = "<div class='no-photos'>‚ùå ID do visualizador n√£o encontrado na URL.</div>";
    }

    let currentPhotos = [];

    // Receber fotos do visualizador (links IMGBB)
    socket.on("viewer_photos_ready", (photos) => {
      console.log('üì∏ Fotos recebidas no visualizador:', photos);
      
      if (!Array.isArray(photos) || photos.length === 0) {
        gallery.innerHTML = "<div class='no-photos'>üì∑ Nenhuma foto dispon√≠vel no momento.</div>";
        return;
      }
      
      currentPhotos = photos;
      renderGallery(photos);
      
      if (photos.length > 0) {
        downloadAllBtn.style.display = 'block';
      }
    });

    function renderGallery(photos) {
      gallery.innerHTML = '';
      
      photos.forEach((photoUrl, index) => {
        const container = document.createElement("div");
        container.className = "photo-container";

        const img = document.createElement("img");
        img.src = photoUrl;
        img.alt = `Foto ${index + 1}`;
        img.loading = "lazy";
        
        // Adicionar tratamento de erro
        img.onerror = function() {
          this.src = 'https://via.placeholder.com/280x280/333333/ffffff?text=Erro+ao+carregar';
        };

        const downloadBtn = document.createElement("button");
        downloadBtn.className = "download-btn";
        downloadBtn.textContent = `üì• Download Foto ${index + 1}`;
        downloadBtn.onclick = function() {
          downloadImage(photoUrl, `foto-${index + 1}.jpg`);
        };

        container.appendChild(img);
        container.appendChild(downloadBtn);
        gallery.appendChild(container);
      });
    }

    // Download de todas as fotos
    downloadAllBtn.addEventListener('click', () => {
      if (currentPhotos.length === 0) return;
      
      currentPhotos.forEach((photoUrl, index) => {
        setTimeout(() => {
          downloadImage(photoUrl, `foto-${index + 1}.jpg`);
        }, index * 300); // Delay para evitar bloqueio do navegador
      });
    });

    // Fun√ß√£o para for√ßar download
    function downloadImage(url, filename) {
      const link = document.createElement('a');
      link.download = filename;
      link.href = url;
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Mostrar mensagem se n√£o conectar
    setTimeout(() => {
      if (currentPhotos.length === 0 && viewerId) {
        gallery.innerHTML = "<div class='no-photos'>‚ùå N√£o foi poss√≠vel carregar as fotos. Verifique o ID da sess√£o.</div>";
      }
    }, 5000);
  </script>
</body>
</html>
