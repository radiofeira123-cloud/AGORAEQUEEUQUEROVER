<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine Fotogr√°fica ‚Äî Operador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#111; color:#eee; margin:0; padding:20px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    button{ padding:10px 14px; border-radius:8px; border:0; background:#0b84ff; color:white; cursor:pointer; margin:4px; }
    button:disabled{ background:#555; cursor:not-allowed; }
    #qrcode{ margin:12px 0; }
    #thumbs img{ width:160px; border-radius:6px; margin:6px; border:2px solid #222; background:#222; }
    canvas{ display:block; margin-top:12px; border:1px solid #333; background:#000; max-width:100%; }
    #log{ margin-top:12px; color:#9f9; white-space:pre-wrap; }
  </style>
</head>
<body>
  <header>
    <h1>Cabine Fotogr√°fica ‚Äî Operador</h1>
    <div>
      <button id="genQr">Gerar QR Code Celular</button>
      <button id="endSession" disabled>Finalizar Sess√£o</button>
      <button id="uploadImgbb" disabled>Gerar & Enviar (IMGBB)</button>
      <button id="printBtn" disabled>Imprimir (9x13)</button>
    </div>
  </header>

  <section>
    <div id="qrcode"></div>
    <div><strong>Sess√£o:</strong> <span id="sessionId">‚Äî</span></div>

    <h3>üì∑ Fotos recebidas</h3>
    <div id="thumbs"></div>

    <h3>üñºÔ∏è Montagem (Stories)</h3>
    <canvas id="storiesCanvas" width="3375" height="6000"></canvas>

    <h3>üñ®Ô∏è Montagem (9x13)</h3>
    <canvas id="printCanvas" width="3322" height="4798"></canvas>

    <div id="log"></div>
  </section>

  <script>
    const SERVER_URL = "https://agoraequeeuquerover.onrender.com";

    const STORIES_COORDS = [
      { x: 152, y: 572,  w: 2371, h: 1540 },
      { x: 152, y: 2225, w: 2371, h: 1541 },
      { x: 155, y: 3885, w: 2365, h: 1546 }
    ];
    const PRINT_COORDS = [
      { x: 150, y: 150,  w: 2216, h: 1434 },
      { x: 150, y: 1684, w: 2210, h: 1437 },
      { x: 150, y: 3232, w: 2213, h: 1435 }
    ];
    const IMGBB_API_KEY = "6734e028b20f88d5795128d242f85582";

    const socket = io(SERVER_URL, { transports: ["websocket","polling"] });
    let currentSession = null, lastPhotos = [];
    const el = id => document.getElementById(id);
    const thumbs = el("thumbs"), qrcodeEl = el("qrcode"),
          storiesCanvas = el("storiesCanvas"), printCanvas = el("printCanvas"),
          logEl = el("log");

    function log(t){ logEl.textContent = `[${new Date().toLocaleTimeString()}] ${t}`; console.log(t); }

    el("genQr").onclick = ()=> socket.emit("create_session");

    socket.on("session_created", id=>{
      currentSession = id;
      el("sessionId").textContent = id;
      const url = `${SERVER_URL}/celular.html?session=${id}`;
      qrcodeEl.innerHTML = "";
      QRCode.toCanvas(url, { width:200 }, (_, c)=>qrcodeEl.appendChild(c));
      log("Sess√£o criada: "+id);
      el("endSession").disabled = false;
      socket.emit("join_room", { session:id });
    });

    socket.on("photos_ready", photos=>{
      log(`Recebidas ${photos.length} fotos`);
      if(!photos?.length) return;
      lastPhotos = photos;
      renderThumbs();
      drawMontages();
      el("uploadImgbb").disabled = false;
      el("printBtn").disabled = false;
    });

    el("endSession").onclick = ()=>{
      if(!currentSession) return;
      socket.emit("end_session", currentSession);
      qrcodeEl.innerHTML = "";
      thumbs.innerHTML = "";
      lastPhotos = [];
      el("uploadImgbb").disabled = el("printBtn").disabled = true;
      el("endSession").disabled = true;
      storiesCanvas.getContext("2d").clearRect(0,0,storiesCanvas.width,storiesCanvas.height);
      printCanvas.getContext("2d").clearRect(0,0,printCanvas.width,printCanvas.height);
      log("Sess√£o encerrada.");
    };

    function renderThumbs(){
      thumbs.innerHTML = "";
      lastPhotos.forEach(p=>{
        const img=document.createElement("img"); img.src=p; thumbs.appendChild(img);
      });
    }

    function drawMontages(){
      draw(storiesCanvas,"caralho.png",STORIES_COORDS);
      draw(printCanvas,"imprimir.png",PRINT_COORDS);
    }

    function draw(canvas,bg,coords){
      const ctx=canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const bgImg=new Image();
      bgImg.src=bg;
      bgImg.onload=()=>{
        ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);
        lastPhotos.forEach((p,i)=>{
          const img=new Image(); img.src=p;
          img.onload=()=>{
            const c=coords[i]; if(!c) return;
            const r1=img.width/img.height, r2=c.w/c.h;
            let sx=0,sy=0,sw=img.width,sh=img.height;
            if(r1>r2){sw=img.height*r2;sx=(img.width-sw)/2;}
            else{sh=img.width/r2;sy=(img.height-sh)/2;}
            ctx.drawImage(img,sx,sy,sw,sh,c.x,c.y,c.w,c.h);
          };
        });
      };
    }

    el("uploadImgbb").onclick = async()=>{
      if(!lastPhotos.length) return alert("Nenhuma foto.");
      log("Enviando para IMGBB...");
      for(const p of lastPhotos){
        const b=p.split(",")[1];
        const f=new FormData(); f.append("key",IMGBB_API_KEY); f.append("image",b);
        await fetch("https://api.imgbb.com/1/upload",{method:"POST",body:f});
      }
      alert("Upload conclu√≠do!");
    };

    el("printBtn").onclick = ()=>{
      const d=printCanvas.toDataURL("image/png");
      const w=window.open(""); w.document.write(`<img src="${d}" style="max-width:100%">`);
      w.document.close(); setTimeout(()=>w.print(),500);
    };
  </script>
</body>
</html>
