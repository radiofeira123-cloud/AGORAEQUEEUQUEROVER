<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine Fotogr√°fica ‚Äî Operador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body{font-family:Arial, sans-serif; background:#111; color:#eee; margin:0; padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0 0 8px 0}
    button{background:#0b84ff;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;margin-right:8px}
    button:disabled{background:#444;cursor:not-allowed}
    .qrcode-container{margin:12px 0;padding:10px;background:#222;border-radius:8px;display:inline-block}
    .qrcode-section{margin:20px 0}
    #thumbs{display:flex;flex-wrap:wrap;gap:8px}
    #thumbs img{width:170px;height:auto;border-radius:6px;border:2px solid #222}
    canvas{max-width:100%;display:block;margin-top:12px;border:1px solid #333;background:#000}
    #log{color:#9f9;margin-top:12px;white-space:pre-wrap;font-family:monospace;font-size:12px}
    .status{background:#333;padding:8px;border-radius:4px;margin:8px 0}
    .connected{color:#4CAF50;}
    .disconnected{color:#f44336;}
    .viewer-info{background:#333;padding:10px;border-radius:5px;margin:10px 0}
    .viewer-history{background:#222;padding:10px;border-radius:5px;margin:10px 0;max-height:200px;overflow-y:auto}
    .viewer-item{margin:5px 0;padding:5px;background:#333;border-radius:3px}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üì∏ Cabine Fotogr√°fica ‚Äî Operador</h1>
      <div id="connectionStatus" class="status disconnected">üî¥ Desconectado</div>
    </div>
    <div style="display:flex;align-items:center;">
      <button id="genQr">Gerar QR Code Celular</button>
      <button id="finalizarSessao" disabled>Finalizar Sess√£o</button>
      <button id="genVisualizadorQr" disabled>Gerar QR Visualizador + IMGBB</button>
      <button id="printBtn" disabled>Imprimir (9x14)</button>
      <button id="debugBtn">Debug</button>
      <button id="testImgbbBtn" style="background:#28a745">Testar IMGBB</button>
      <button id="limparVisualizadorBtn" style="background:#dc3545">Limpar Visualizador</button>
    </div>
  </header>

  <div id="sessionInfo">
    <div>Sess√£o: <strong id="sessionId">‚Äî</strong></div>
    
    <div class="qrcode-section">
      <h3>QR Code para Celular (Cabine - SESS√ÉO FIXA)</h3>
      <div id="qrcode" class="qrcode-container"></div>
    </div>
    
    <div class="qrcode-section">
      <h3>QR Code para Visualizador (Cliente - SESS√ÉO √öNICA)</h3>
      <div id="qrcodeVisualizador" class="qrcode-container"></div>
      <div id="viewerInfo" class="viewer-info" style="display:none;">
        <p><strong>Sess√£o Visualizador:</strong> <span id="viewerSessionId">‚Äî</span></p>
        <p><strong>Expira em:</strong> 7 dias</p>
      </div>
    </div>

    <!-- Hist√≥rico de visualizadores -->
    <div class="qrcode-section">
      <h3>Hist√≥rico de Visualizadores</h3>
      <div id="viewerHistory" class="viewer-history">
        <div class="viewer-item">Nenhum visualizador gerado ainda</div>
      </div>
    </div>
  </div>

  <h3>Fotos recebidas</h3>
  <div id="thumbs"></div>

  <h3>Preview ‚Äî Montagem Stories</h3>
  <canvas id="storiesCanvas" width="3375" height="6000"></canvas>

  <h3>Preview ‚Äî Impress√£o (9x14)</h3>
  <canvas id="printCanvas" width="3322" height="5167"></canvas>

  <div id="log"></div>

  <script>
    const SERVER_URL = "https://agoraequeeuquerover.onrender.com";

    // ‚úÖ COORDENADAS CORRIGIDAS PARA STORIES (caralho (1).png - 3375x6000px)
    const STORIES_COORDS = [
      { x: 152, y: 379,  w: 2228, h: 1350 },   // √Årea 1: (152,379) a (2380,1729)
      { x: 152, y: 1815, w: 2228, h: 1349 },   // √Årea 2: (152,1815) a (2380,3164)  
      { x: 149, y: 3254, w: 2231, h: 1353 }    // √Årea 3: (149,3254) a (2380,4607)
    ];

    // ‚úÖ COORDENADAS CORRIGIDAS PARA IMPRESS√ÉO 9x14 (imprimir (1).png - 3322x5167px)
    const PRINT_COORDS = [
      { x: 188, y: 182,  w: 2166, h: 1308 },   // √Årea 1: (188,182) a (2354,1490)
      { x: 185, y: 1578, w: 2169, h: 1311 },   // √Årea 2: (185,1578) a (2354,2889)
      { x: 185, y: 2977, w: 2172, h: 1314 }    // √Årea 3: (185,2977) a (2357,4291)
    ];

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o de otimiza√ß√£o para IMGBB apenas (n√£o limita resolu√ß√£o original)
    function optimizeImageForImgbb(dataUrl, quality = 0.9) {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = dataUrl;
            img.onload = () => {
                console.log(`üìä Imagem original: ${img.width}x${img.height} (${Math.round(dataUrl.length/1024)}KB)`);
                
                // ‚úÖ MANTER resolu√ß√£o alta mas otimizar qualidade para upload
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Usar as dimens√µes originais (3264x1836)
                canvas.width = img.width;
                canvas.height = img.height;
                
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const optimizedDataUrl = canvas.toDataURL('image/jpeg', quality);
                
                console.log(`‚úÖ Otimizada para IMGBB: ${img.width}x${img.height} (${Math.round(optimizedDataUrl.length/1024)}KB)`);
                resolve(optimizedDataUrl);
            };
            img.onerror = () => resolve(dataUrl);
        });
    }

    const socket = io(SERVER_URL, {
      transports: ['websocket', 'polling'],
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 30000,
      forceNew: true,
      withCredentials: true
    });

    const el = id => document.getElementById(id);
    const qrcodeEl = el('qrcode'), qrcodeVisualizadorEl = el('qrcodeVisualizador');
    const sessionIdEl = el('sessionId'), viewerSessionIdEl = el('viewerSessionId');
    const viewerInfoEl = el('viewerInfo'), viewerHistoryEl = el('viewerHistory');
    const thumbsEl = el('thumbs'), storiesCanvas = el('storiesCanvas'), printCanvas = el('printCanvas');
    const logEl = el('log');
    const connectionStatusEl = el('connectionStatus');

    const genQrBtn = el('genQr'), finalizarBtn = el('finalizarSessao');
    const genVisualizadorQrBtn = el('genVisualizadorQr'), printBtn = el('printBtn');
    const debugBtn = el('debugBtn'), testImgbbBtn = el('testImgbbBtn');
    const limparVisualizadorBtn = el('limparVisualizadorBtn');

    let currentSession = null;
    let currentViewerSession = null;
    let lastPhotos = [];
    let viewerHistory = [];

    function log(msg){
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function updateConnectionStatus(connected) {
      if (connected) {
        connectionStatusEl.innerHTML = 'üü¢ Conectado ao Servidor';
        connectionStatusEl.className = 'status connected';
      } else {
        connectionStatusEl.innerHTML = 'üî¥ Desconectado';
        connectionStatusEl.className = 'status disconnected';
      }
    }

    socket.on('connect', () => {
      log('‚úÖ CONECTADO ao servidor: ' + SERVER_URL);
      updateConnectionStatus(true);
      
      // Conectar √† sess√£o FIXA como operador
      socket.emit('operator_connected');
    });

    socket.on('session_ready', ({ sessionId }) => {
      currentSession = sessionId;
      sessionIdEl.textContent = sessionId;
      
      generateQrCode();
      
      log('‚úÖ Sess√£o FIXA conectada: ' + sessionId);
      genQrBtn.disabled = false;
      finalizarBtn.disabled = false;
    });

    socket.on('disconnect', (reason) => {
      log('‚ùå DESCONECTADO: ' + reason);
      updateConnectionStatus(false);
    });

    socket.on('connect_error', (error) => {
      log('‚ùå ERRO de conex√£o: ' + error.message);
      updateConnectionStatus(false);
      console.error('Socket.IO error:', error);
    });

    socket.on('reconnect_attempt', (attempt) => {
      log(`üîÑ Tentativa de reconex√£o ${attempt}`);
    });

    socket.on('reconnect', (attempt) => {
      log(`‚úÖ Reconectado ap√≥s ${attempt} tentativas`);
      updateConnectionStatus(true);
      
      // Re-conectar √† sess√£o FIXA
      if (currentSession) {
        socket.emit('operator_connected');
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      log('üîÑ Conectando √† sess√£o FIXA...');
    });

    genQrBtn.addEventListener('click', () => {
      generateQrCode();
    });

    // ‚úÖ CORRE√á√ÉO: Bot√£o IMGBB mantendo RESOLU√á√ÉO M√ÅXIMA
    genVisualizadorQrBtn.addEventListener('click', async () => {
      if (lastPhotos.length === 0) {
        log('‚ùå Nenhuma foto dispon√≠vel para gerar visualizador');
        return;
      }
      
      log('üîç INICIANDO PROCESSO IMGBB...');
      log(`üìä Dados: ${lastPhotos.length} fotos, sess√£o: ${currentSession}`);
      
      try {
        // ‚úÖ CORRE√á√ÉO: OTIMIZAR mantendo RESOLU√á√ÉO M√ÅXIMA 3264x1836
        log('üîÑ Otimizando fotos para IMGBB (mantendo resolu√ß√£o m√°xima)...');
        const optimizedPhotos = [];
        
        for (let i = 0; i < lastPhotos.length; i++) {
          const optimizedPhoto = await optimizeImageForImgbb(lastPhotos[i], 0.9);
          optimizedPhotos.push(optimizedPhoto);
          log(`‚úÖ Foto ${i+1} otimizada para IMGBB: ${Math.round(optimizedPhoto.length/1024)}KB`);
        }
        
        // ‚úÖ CORRE√á√ÉO: Montagem stories tamb√©m em alta qualidade
        const storiesMontage = storiesCanvas.toDataURL('image/jpeg', 0.95);
        const optimizedStoriesMontage = await optimizeImageForImgbb(storiesMontage, 0.9);
        
        // ‚úÖ NOVO LOG: Verificar se a montagem do stories est√° sendo enviada
        console.log('üñºÔ∏è Stories Montage para envio:', optimizedStoriesMontage ? 'SIM' : 'N√ÉO');
        console.log('üìä Tamanho stories:', optimizedStoriesMontage ? Math.round(optimizedStoriesMontage.length/1024) + 'KB' : 'N/A');
        
        log(`‚úÖ Montagem stories otimizada: ${Math.round(optimizedStoriesMontage.length/1024)}KB`);
        
        log('üîÑ Criando NOVA sess√£o do visualizador...');
        log(`üì§ Enviando ${optimizedPhotos.length} fotos em ALTA RESOLU√á√ÉO + montagem stories`);
        
        genVisualizadorQrBtn.disabled = true;
        genVisualizadorQrBtn.textContent = 'Enviando...';
        
        // Timeout para evitar travamento
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Timeout no envio para IMGBB')), 60000); // 60 segundos
        });
        
        const sendPromise = new Promise((resolve, reject) => {
          socket.emit('create_viewer_session', { 
              photos: optimizedPhotos,
              storiesMontage: optimizedStoriesMontage
          });
          
          // Esperar pela resposta
          const successHandler = ({ viewerId }) => {
            socket.off('viewer_session_created', successHandler);
            socket.off('viewer_session_error', errorHandler);
            resolve(viewerId);
          };
          
          const errorHandler = ({ error }) => {
            socket.off('viewer_session_created', successHandler);
            socket.off('viewer_session_error', errorHandler);
            reject(new Error(error));
          };
          
          socket.on('viewer_session_created', successHandler);
          socket.on('viewer_session_error', errorHandler);
        });
        
        // Race entre o envio e o timeout
        const viewerId = await Promise.race([sendPromise, timeoutPromise]);
        log('üéâ Sess√£o do visualizador criada com sucesso: ' + viewerId);
        
      } catch (error) {
        log('‚ùå‚ùå‚ùå ERRO no processo IMGBB: ' + error.message);
        genVisualizadorQrBtn.disabled = false;
        genVisualizadorQrBtn.textContent = 'Gerar QR Visualizador + IMGBB';
        
        // Tentar reconectar se houve timeout
        if (error.message.includes('Timeout')) {
          log('üîÑ Tentando reconectar socket...');
          socket.connect();
        }
      }
    });

    // BOT√ÉO DE TESTE IMGBB
    testImgbbBtn.addEventListener('click', async () => {
      if (lastPhotos.length === 0) {
        log('‚ùå Nenhuma foto para testar IMGBB');
        return;
      }
      
      log('üß™ TESTE IMGBB - Enviando uma foto de teste em ALTA RESOLU√á√ÉO...');
      
      try {
        const testPhoto = await optimizeImageForImgbb(lastPhotos[0], 0.9);
        
        const base64Data = testPhoto.split(',')[1];
        const formData = new FormData();
        formData.append('key', '6734e028b20f88d5795128d242f85582');
        formData.append('image', base64Data);
        
        const response = await fetch('https://api.imgbb.com/1/upload', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        if (data.success) {
          log('‚úÖ‚úÖ‚úÖ TESTE IMGBB SUCESSO! URL: ' + data.data.url);
          log('üîß Upload em alta resolu√ß√£o funcionando!');
        } else {
          log('‚ùå TESTE IMGBB FALHOU: ' + (data.error?.message || 'Erro desconhecido'));
        }
      } catch (error) {
        log('‚ùå ERRO no teste IMGBB: ' + error.message);
      }
    });

    function generateQrCode() {
      qrcodeEl.innerHTML = '';
      const url = `${SERVER_URL}/celular.html?session=${encodeURIComponent(currentSession)}`;
      const canvas = document.createElement('canvas');
      QRCode.toCanvas(canvas, url, { width: 220 }, (err) => {
        if (err) {
          log('‚ùå Erro ao gerar QR Code: ' + err);
          return;
        }
      });
      qrcodeEl.appendChild(canvas);
      log('üì± QR Code Celular gerado para sess√£o FIXA: ' + currentSession);
    }

    function generateVisualizadorQrCode(viewerId) {
      qrcodeVisualizadorEl.innerHTML = '';
      const url = `${SERVER_URL}/visualizador.html?viewerId=${encodeURIComponent(viewerId)}`;
      const canvas = document.createElement('canvas');
      QRCode.toCanvas(canvas, url, { width: 220 }, (err) => {
        if (err) {
          log('‚ùå Erro ao gerar QR Code Visualizador: ' + err);
          return;
        }
      });
      qrcodeVisualizadorEl.appendChild(canvas);
      
      viewerSessionIdEl.textContent = viewerId;
      viewerInfoEl.style.display = 'block';
      currentViewerSession = viewerId;
      
      // ADICIONAR AO HIST√ìRICO
      const viewerItem = {
        id: viewerId,
        timestamp: new Date().toLocaleTimeString(),
        photosCount: lastPhotos.length
      };
      viewerHistory.unshift(viewerItem);
      updateViewerHistory();
      
      log('üëÄ NOVO QR Code Visualizador gerado: ' + viewerId);
      log('‚úÖ‚úÖ‚úÖ Fotos em ALTA RESOLU√á√ÉO enviadas para IMGBB com SUCESSO!');
      
      // Restaurar bot√£o
      genVisualizadorQrBtn.disabled = false;
      genVisualizadorQrBtn.textContent = 'Gerar QR Visualizador + IMGBB';
    }

    function updateViewerHistory() {
      viewerHistoryEl.innerHTML = '';
      
      if (viewerHistory.length === 0) {
        viewerHistoryEl.innerHTML = '<div class="viewer-item">Nenhum visualizador gerado ainda</div>';
        return;
      }
      
      viewerHistory.forEach(item => {
        const div = document.createElement('div');
        div.className = 'viewer-item';
        div.innerHTML = `
          <strong>${item.timestamp}</strong> - 
          ${item.photosCount} fotos - 
          ID: ${item.id.substring(0, 8)}...
        `;
        viewerHistoryEl.appendChild(div);
      });
    }

    socket.on('viewer_session_created', ({ viewerId }) => {
      currentViewerSession = viewerId;
      log('üéâ NOVA Sess√£o do visualizador criada: ' + viewerId);
      generateVisualizadorQrCode(viewerId);
    });

    socket.on('viewer_session_error', ({ error }) => {
      log('‚ùå‚ùå‚ùå ERRO ao criar visualizador: ' + error);
      genVisualizadorQrBtn.disabled = false;
      genVisualizadorQrBtn.textContent = 'Gerar QR Visualizador + IMGBB';
      log('üîß Verifique os logs do servidor para mais detalhes');
    });

    socket.on('photos_ready', (photos) => {
      log(`üì∏ FOTOS RECEBIDAS: ${photos.length} fotos`);
      
      if (!Array.isArray(photos)) {
        log('‚ùå Fotos n√£o s√£o um array');
        return;
      }
      
      lastPhotos = photos.slice(0, 3);
      renderThumbs();
      drawStories(lastPhotos);
      drawPrint(lastPhotos);
      genVisualizadorQrBtn.disabled = false;
      printBtn.disabled = false;
      testImgbbBtn.disabled = false;
      
      log('‚úÖ Fotos renderizadas com sucesso');
    });

    // Finalizar sess√£o - limpar QR do visualizador atual
    finalizarBtn.addEventListener('click', () => {
      if (!currentSession) return alert('Nenhuma sess√£o ativa.');
      
      socket.emit('end_session');
      
      // Limpar apenas a interface do operador
      thumbsEl.innerHTML = '';
      lastPhotos = [];
      genVisualizadorQrBtn.disabled = true;
      printBtn.disabled = true;
      testImgbbBtn.disabled = true;
      
      // LIMPAR o QR code do visualizador atual
      qrcodeVisualizadorEl.innerHTML = '';
      viewerInfoEl.style.display = 'none';
      currentViewerSession = null;
      
      const storiesCtx = storiesCanvas.getContext('2d');
      storiesCtx.clearRect(0, 0, storiesCanvas.width, storiesCanvas.height);
      
      const printCtx = printCanvas.getContext('2d');
      printCtx.clearRect(0, 0, printCanvas.width, printCanvas.height);
      
      log('üßπ Sess√£o finalizada - Celular resetado para pr√≥ximo cliente');
      log('üì± QR Code do visualizador atual foi limpo');
    });

    // BOT√ÉO PARA LIMPAR VISUALIZADOR MANUALMENTE
    limparVisualizadorBtn.addEventListener('click', () => {
      if (confirm('Tem certeza que deseja limpar o visualizador atual? Isso n√£o afetar√° visualizadores j√° compartilhados.')) {
        qrcodeVisualizadorEl.innerHTML = '';
        viewerInfoEl.style.display = 'none';
        currentViewerSession = null;
        log('üßπ Visualizador limpo da interface (visualizadores compartilhados continuam funcionando)');
      }
    });

    debugBtn.addEventListener('click', () => {
      log('üêõ DEBUG - Estado atual:');
      log('- Sess√£o FIXA: ' + currentSession);
      log('- Socket conectado: ' + socket.connected);
      log('- Socket ID: ' + socket.id);
      log('- Fotos recebidas: ' + lastPhotos.length);
      log('- Visualizadores no hist√≥rico: ' + viewerHistory.length);
      
      fetch(SERVER_URL + '/health')
        .then(r => r.json())
        .then(data => {
          log('ü©∫ Health check OK: ' + JSON.stringify(data));
        })
        .catch(e => {
          log('‚ùå Health check FALHOU: ' + e.message);
        });
    });

    function renderThumbs(){
      thumbsEl.innerHTML = '';
      lastPhotos.forEach((p, idx) => {
        const img = document.createElement('img');
        img.src = p;
        img.alt = 'foto-' + (idx+1);
        thumbsEl.appendChild(img);
      });
    }

    function drawImageCover(ctx, img, x, y, w, h){
      const imgRatio = img.width / img.height;
      const boxRatio = w / h;
      let sx=0, sy=0, sw=img.width, sh=img.height;
      if (imgRatio > boxRatio) {
        sw = img.height * boxRatio;
        sx = (img.width - sw) / 2;
      } else {
        sh = img.width / boxRatio;
        sy = (img.height - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    }

    function drawStories(photos){
      const ctx = storiesCanvas.getContext('2d');
      ctx.clearRect(0,0,storiesCanvas.width, storiesCanvas.height);
      
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      
      const bg = new Image();
      bg.src = 'caralho (1).png';
      bg.onload = () => {
        log('‚úÖ Background stories carregado: caralho (1).png - 3375x6000px');
        ctx.drawImage(bg, 0, 0, storiesCanvas.width, storiesCanvas.height);
        
        photos.forEach((p, i) => {
          const img = new Image();
          img.src = p;
          img.onload = () => {
            const c = STORIES_COORDS[i];
            if (!c) return;
            drawImageCover(ctx, img, c.x, c.y, c.w, c.h);
            log(`‚úÖ Foto ${i+1} posicionada no stories: X=${c.x}, Y=${c.y}, W=${c.w}, H=${c.h}`);
            
            // ‚úÖ DEBUG: Desenhar ret√¢ngulo vermelho para verificar posi√ß√£o
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 4;
            ctx.strokeRect(c.x, c.y, c.w, c.h);
          };
          img.onerror = () => log('‚ùå Erro ao cargar imagem: ' + p.substring(0, 50));
        });
      };
      bg.onerror = () => log('‚ùå Erro ao cargar background stories');
    }

    function drawPrint(photos){
      const ctx = printCanvas.getContext('2d');
      ctx.clearRect(0,0,printCanvas.width, printCanvas.height);
      
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      
      const bg = new Image();
      bg.src = 'imprimir (1).png';
      bg.onload = () => {
        log('‚úÖ Background print carregado: imprimir (1).png - 3322x5167px');
        ctx.drawImage(bg, 0, 0, printCanvas.width, printCanvas.height);
        
        photos.forEach((p, i) => {
          const img = new Image(); 
          img.src = p;
          img.onload = () => {
            const c = PRINT_COORDS[i]; 
            if (!c) return;
            drawImageCover(ctx, img, c.x, c.y, c.w, c.h);
            log(`‚úÖ Foto ${i+1} posicionada no print: X=${c.x}, Y=${c.y}, W=${c.w}, H=${c.h}`);
            
            // ‚úÖ DEBUG: Desenhar ret√¢ngulo vermelho para verificar posi√ß√£o
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 4;
            ctx.strokeRect(c.x, c.y, c.w, c.h);
          };
          img.onerror = () => log('‚ùå Erro ao cargar imagem para print: ' + p.substring(0, 50));
        });
      };
      bg.onerror = () => log('‚ùå Erro ao cargar background print');
    }

    printBtn.addEventListener('click', () => {
      if (!lastPhotos.length) return alert('Nenhuma foto.');
      
      const data = printCanvas.toDataURL('image/png');
      const w = window.open('');
      
      w.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Impress√£o Cabine Fotogr√°fica</title>
          <style>
            body { 
              margin: 0; 
              padding: 0; 
              background: white;
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
            }
            img { 
              max-width: 100%;
              max-height: 100vh;
              width: auto;
              height: auto;
              display: block;
              margin: 0 auto;
            }
            @media print {
              body { margin: 0; padding: 0; }
              img { 
                max-width: 100% !important;
                max-height: 100vh !important;
                width: auto !important;
                height: auto !important;
                page-break-inside: avoid;
              }
              @page {
                margin: 0;
                size: auto;
              }
            }
          </style>
        </head>
        <body>
          <img src="${data}" alt="Foto da Cabine" onload="window.print()">
        </body>
        </html>
      `);
      w.document.close();
      
      w.onload = function() {
        setTimeout(() => {
          w.print();
        }, 500);
      };
    });
  </script>
</body>
</html>
