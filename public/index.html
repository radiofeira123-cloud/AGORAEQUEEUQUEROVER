<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cabine Fotográfica - Operador</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Cabine Fotográfica - Operador</h1>
  <button id="genQR">Gerar QR Code para Celular</button>
  <div id="qrcode"></div>
  <button id="endSession">Finalizar Sessão</button>
  <button id="uploadBtn">Gerar & Enviar (IMGBB)</button>
  <button id="printBtn">Imprimir</button>

  <h2>Fotos recebidas</h2>
  <div id="photos"></div>

  <h2>Preview Stories</h2>
  <canvas id="storiesCanvas" width="3375" height="6000"></canvas>

  <h2>Preview Impressão</h2>
  <canvas id="printCanvas" width="3322" height="4798"></canvas>

  <script>
    const socket = io("https://agoraequeeuquerover.onrender.com", {
      transports: ["websocket", "polling"]
    });
    let sessionId = null;
    let photos = [];

    const STORIES_COORDS = [
      { x: 152, y: 572,  w: 2371, h: 1540 },
      { x: 152, y: 2225, w: 2371, h: 1541 },
      { x: 155, y: 3885, w: 2365, h: 1546 }
    ];
    const PRINT_COORDS = [
      { x: 150, y: 150,  w: 2216, h: 1434 },
      { x: 150, y: 1684, w: 2210, h: 1437 },
      { x: 150, y: 3232, w: 2213, h: 1435 }
    ];

    document.getElementById('genQR').onclick = () => {
      sessionId = "sess-" + Math.random().toString(36).substr(2,6);
      socket.emit('join_room', { session: sessionId });

      const url = "https://agoraequeeuquerover.onrender.com/celular.html?session=" + sessionId;
      if (url) {
        QRCode.toCanvas(document.getElementById("qrcode"), url)
          .catch(err => console.error("Erro QR:", err));
      }
    };

    document.getElementById('endSession').onclick = () => {
      if (sessionId) socket.emit('end_session', { session: sessionId });
      photos = [];
      document.getElementById('photos').innerHTML = "";
    };

    socket.on('photos_from_cell', (data) => {
      photos = data.photos;
      const div = document.getElementById('photos');
      div.innerHTML = "";
      photos.forEach(p => {
        const img = new Image();
        img.src = p;
        img.width = 150;
        div.appendChild(img);
      });
      drawMoldura("storiesCanvas", "caralho.png", STORIES_COORDS);
      drawMoldura("printCanvas", "imprimir.png", PRINT_COORDS);
    });

    async function drawMoldura(canvasId, moldura, coords) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const bg = await loadImg(moldura);
      ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

      for (let i=0; i<photos.length; i++) {
        const img = await loadImg(photos[i]);
        const {x,y,w,h} = coords[i];
        ctx.drawImage(img, x,y,w,h,h * (img.height/img.width));
      }
    }

    function loadImg(src) {
      return new Promise(r => {
        const i = new Image();
        i.onload = () => r(i);
        i.src = src;
      });
    }
  </script>
</body>
</html>
