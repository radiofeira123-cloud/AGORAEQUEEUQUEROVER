<!-- public/index.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine FotogrÃ¡fica â€” Operador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body{font-family:Arial, sans-serif; background:#111; color:#eee; margin:0; padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0 0 8px 0}
    button{background:#0b84ff;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;margin-right:8px}
    button:disabled{background:#444;cursor:not-allowed}
    #qrcode{margin:12px 0}
    #thumbs{display:flex;flex-wrap:wrap;gap:8px}
    #thumbs img{width:170px;height:auto;border-radius:6px;border:2px solid #222}
    canvas{max-width:100%;display:block;margin-top:12px;border:1px solid #333;background:#000}
    #log{color:#9f9;margin-top:12px;white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ðŸ“¸ Cabine FotogrÃ¡fica â€” Operador</h1>
    </div>
    <div style="display:flex;align-items:center;">
      <button id="genQr">Gerar QR Code Celular</button>
      <button id="finalizarSessao" disabled>Finalizar SessÃ£o</button>
      <button id="uploadImgbb" disabled>Enviar (IMGBB)</button>
      <button id="printBtn" disabled>Imprimir (9x13)</button>
    </div>
  </header>

  <div id="sessionInfo">
    <div>SessÃ£o: <strong id="sessionId">â€”</strong></div>
    <div id="qrcode"></div>
  </div>

  <h3>Fotos recebidas</h3>
  <div id="thumbs"></div>

  <h3>Preview â€” Montagem Stories</h3>
  <canvas id="storiesCanvas" width="3375" height="6000"></canvas>

  <h3>Preview â€” ImpressÃ£o (9x13)</h3>
  <canvas id="printCanvas" width="3322" height="4798"></canvas>

  <div id="log"></div>

  <script>
    // CONFIG: troque se teu servidor estiver em outro host
    const SERVER_URL = "https://agoraequeeuquerover.onrender.com";
    const IMGBB_API_KEY = "6734e028b20f88d5795128d242f85582"; // coloca tua chave aqui (opcional)

    // Coordenadas conforme enviado por vocÃª
    const STORIES_COORDS = [
      { x: 152, y: 572,  w: 2371, h: 1540 },
      { x: 152, y: 2225, w: 2371, h: 1541 },
      { x: 155, y: 3885, w: 2365, h: 1546 }
    ];
    const PRINT_COORDS = [
      { x: 150, y: 150,  w: 2216, h: 1434 },
      { x: 150, y: 1684, w: 2210, h: 1437 },
      { x: 150, y: 3232, w: 2213, h: 1435 }
    ];

    // usa polling (compatÃ­vel com Render) â€” se teu servidor suporta websocket direto, podes remover transports
    const socket = io(SERVER_URL, { transports: ['polling'], reconnection: true });

    const el = id => document.getElementById(id);
    const qrcodeEl = el('qrcode'), sessionIdEl = el('sessionId');
    const thumbsEl = el('thumbs'), storiesCanvas = el('storiesCanvas'), printCanvas = el('printCanvas');
    const logEl = el('log');

    const genQrBtn = el('genQr'), finalizarBtn = el('finalizarSessao'), uploadBtn = el('uploadImgbb'), printBtn = el('printBtn');

    let currentSession = null;
    let lastPhotos = [];

    function log(msg){
      logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      console.log(msg);
    }

    // Gera sessÃ£o (faz apenas 1x no inÃ­cio do turno)
    genQrBtn.addEventListener('click', ()=> {
      socket.emit('create_session');
    });

    socket.on('session_created', (id) => {
      currentSession = id;
      sessionIdEl.textContent = id;
      qrcodeEl.innerHTML = '';
      // cria canvas QR
      const url = `${SERVER_URL}/celular.html?session=${encodeURIComponent(id)}`;
      const canvas = document.createElement('canvas');
      QRCode.toCanvas(canvas, url, { width: 220 }, (err) => {
        if (err) { console.error(err); return; }
      });
      qrcodeEl.appendChild(canvas);
      log('SessÃ£o criada: ' + id);
      genQrBtn.disabled = true;       // nÃ£o gerar outra sessÃ£o enquanto esta ativa
      finalizarBtn.disabled = false;
      // operator joins room to receive photos
      socket.emit('join_room', { session: id });
    });

    // quando celular avisa que entrou em fullscreen -> esconde QR
    socket.on('cell_entered_fullscreen', ({ session }) => {
      if (session === currentSession) {
        qrcodeEl.style.display = 'none';
        log('Celular entrou em tela cheia â€” QR escondido');
      }
    });

    // fotos prontas (server reenvia para operator)
    socket.on('photos_ready', (photos) => {
      if (!Array.isArray(photos)) return;
      lastPhotos = photos.slice(0,3);
      renderThumbs();
      drawStories(lastPhotos);
      drawPrint(lastPhotos);
      uploadBtn.disabled = false;
      printBtn.disabled = false;
      log('Fotos recebidas e renderizadas.');
    });

    // Finalizar sessÃ£o (operator)
    finalizarBtn.addEventListener('click', () => {
      if (!currentSession) return alert('Nenhuma sessÃ£o ativa.');
      // pede ao servidor resetar o celular e limpar fotos (mas mantÃ©m session id)
      socket.emit('end_session', currentSession);
      // local cleanup display (keep currentSession so celular remains paired)
      thumbsEl.innerHTML = '';
      lastPhotos = [];
      uploadBtn.disabled = true;
      printBtn.disabled = true;
      log('Finalizar sessÃ£o enviado (celular deve voltar Ã  tela inicial).');
    });

    // Render thumbs
    function renderThumbs(){
      thumbsEl.innerHTML = '';
      lastPhotos.forEach((p, idx) => {
        const img = document.createElement('img');
        img.src = p;
        img.alt = 'foto-' + (idx+1);
        thumbsEl.appendChild(img);
      });
    }

    // draw helper (cover)
    function drawImageCover(ctx, img, x, y, w, h){
      const imgRatio = img.width / img.height;
      const boxRatio = w / h;
      let sx=0, sy=0, sw=img.width, sh=img.height;
      if (imgRatio > boxRatio) {
        sw = img.height * boxRatio;
        sx = (img.width - sw) / 2;
      } else {
        sh = img.width / boxRatio;
        sy = (img.height - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    }

    function drawStories(photos){
      const ctx = storiesCanvas.getContext('2d');
      ctx.clearRect(0,0,storiesCanvas.width, storiesCanvas.height);
      const bg = new Image();
      bg.src = 'caralho.png';
      bg.onload = () => {
        ctx.drawImage(bg, 0, 0, storiesCanvas.width, storiesCanvas.height);
        photos.forEach((p, i) => {
          const img = new Image();
          img.src = p;
          img.onload = () => {
            const c = STORIES_COORDS[i];
            if (!c) return;
            drawImageCover(ctx, img, c.x, c.y, c.w, c.h);
          };
        });
      };
    }

    function drawPrint(photos){
      const ctx = printCanvas.getContext('2d');
      ctx.clearRect(0,0,printCanvas.width, printCanvas.height);
      const bg = new Image();
      bg.src = 'imprimir.png';
      bg.onload = () => {
        ctx.drawImage(bg, 0, 0, printCanvas.width, printCanvas.height);
        photos.forEach((p, i) => {
          const img = new Image(); img.src = p;
          img.onload = () => {
            const c = PRINT_COORDS[i]; if (!c) return;
            drawImageCover(ctx, img, c.x, c.y, c.w, c.h);
          };
        });
      };
    }

    // Upload IMGBB (client side)
    uploadBtn.addEventListener('click', async () => {
      if (!IMGBB_API_KEY) return alert('Coloque IMGBB_API_KEY no cÃ³digo para habilitar upload.');
      if (!lastPhotos.length) return alert('Nenhuma foto.');
      log('Enviando fotos para IMGBB...');
      try {
        for (let i = 0; i < lastPhotos.length; i++) {
          const base = lastPhotos[i].split(',')[1];
          const fd = new FormData(); fd.append('key', IMGBB_API_KEY); fd.append('image', base);
          const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: fd });
          const j = await res.json();
          log('Foto ' + (i+1) + ' enviada: ' + (j.data?.url || 'sem-url'));
        }
        // enviar montagem stories tambÃ©m
        const montage = storiesCanvas.toDataURL('image/jpeg', 0.92).split(',')[1];
        const fd2 = new FormData(); fd2.append('key', IMGBB_API_KEY); fd2.append('image', montage);
        const r2 = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: fd2 });
        const j2 = await r2.json();
        log('Montagem enviada: ' + (j2.data?.url || 'sem-url'));
        alert('Upload concluÃ­do!');
      } catch (e) { console.error(e); alert('Erro no upload: ' + e.message); }
    });

    // Print
    printBtn.addEventListener('click', () => {
      if (!lastPhotos.length) return alert('Nenhuma foto.');
      const data = printCanvas.toDataURL('image/png');
      const w = window.open('');
      w.document.write('<img src="'+data+'" style="max-width:100%;">');
      w.document.close();
      setTimeout(()=> w.print(), 700);
    });

  </script>
</body>
</html>
