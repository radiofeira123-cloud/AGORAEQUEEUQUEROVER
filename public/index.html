<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Cabine Fotogr√°fica ‚Äî Operador</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body{font-family:Arial, sans-serif; background:#111; color:#eee; margin:0; padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{margin:0 0 8px 0}
    button{background:#0b84ff;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;margin-right:8px}
    button:disabled{background:#444;cursor:not-allowed}
    .qrcode-container{margin:12px 0;padding:10px;background:#222;border-radius:8px;display:inline-block}
    .qrcode-section{margin:20px 0}
    #thumbs{display:flex;flex-wrap:wrap;gap:8px}
    #thumbs img{width:170px;height:auto;border-radius:6px;border:2px solid #222}
    canvas{max-width:100%;display:block;margin-top:12px;border:1px solid #333;background:#000}
    #log{color:#9f9;margin-top:12px;white-space:pre-wrap;font-family:monospace;font-size:12px}
    .download-btn{background:#28a745;margin-left:5px;}
    .viewer-info{background:#333;padding:10px;border-radius:5px;margin:10px 0}
    .status{background:#333;padding:8px;border-radius:4px;margin:8px 0}
    .connected{color:#4CAF50;}
    .disconnected{color:#f44336;}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>üì∏ Cabine Fotogr√°fica ‚Äî Operador</h1>
      <div id="connectionStatus" class="status disconnected">üî¥ Desconectado</div>
    </div>
    <div style="display:flex;align-items:center;">
      <button id="genQr">Gerar QR Code Celular</button>
      <button id="genVisualizadorQr" disabled>Gerar QR Visualizador + IMGBB</button>
      <button id="finalizarSessao" disabled>Finalizar Sess√£o</button>
      <button id="downloadAllBtn" disabled>Download Todas Fotos</button>
      <button id="printBtn" disabled>Imprimir (9x13)</button>
      <button id="debugBtn">Debug Conex√£o</button>
    </div>
  </header>

  <div id="sessionInfo">
    <div>Sess√£o Celular: <strong id="sessionId">‚Äî</strong></div>
    
    <div class="qrcode-section">
      <h3>QR Code para Celular (Cabine) - SEMPRE VIS√çVEL</h3>
      <div id="qrcode" class="qrcode-container"></div>
    </div>
    
    <div class="qrcode-section">
      <h3>QR Code para Visualizador (Cliente) - GERAR MANUALMENTE</h3>
      <div id="qrcodeVisualizador" class="qrcode-container"></div>
      <div id="viewerInfo" class="viewer-info" style="display:none;">
        <p><strong>Sess√£o Visualizador:</strong> <span id="viewerSessionId">‚Äî</span></p>
        <p><strong>Expira em:</strong> 7 dias</p>
      </div>
    </div>
  </div>

  <h3>Fotos recebidas</h3>
  <div id="thumbs"></div>

  <h3>Preview ‚Äî Montagem Stories</h3>
  <canvas id="storiesCanvas" width="3375" height="6000"></canvas>

  <h3>Preview ‚Äî Impress√£o (9x13)</h3>
  <canvas id="printCanvas" width="3322" height="4798"></canvas>

  <div id="log"></div>

  <script>
    const SERVER_URL = "https://agoraequeeuquerover.onrender.com";

    const STORIES_COORDS = [
      { x: 152, y: 572,  w: 2371, h: 1540 },
      { x: 152, y: 2225, w: 2371, h: 1541 },
      { x: 155, y: 3885, w: 2365, h: 1546 }
    ];
    const PRINT_COORDS = [
      { x: 150, y: 150,  w: 2216, h: 1434 },
      { x: 150, y: 1684, w: 2210, h: 1437 },
      { x: 150, y: 3232, w: 2213, h: 1435 }
    ];

    // Configura√ß√£o Socket.IO robusta
    const socket = io(SERVER_URL, {
      transports: ['polling', 'websocket'],
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1000,
      timeout: 20000,
      forceNew: true
    });

    const el = id => document.getElementById(id);
    const qrcodeEl = el('qrcode'), qrcodeVisualizadorEl = el('qrcodeVisualizador');
    const sessionIdEl = el('sessionId'), viewerSessionIdEl = el('viewerSessionId');
    const viewerInfoEl = el('viewerInfo');
    const thumbsEl = el('thumbs'), storiesCanvas = el('storiesCanvas'), printCanvas = el('printCanvas');
    const logEl = el('log');
    const connectionStatusEl = el('connectionStatus');

    const genQrBtn = el('genQr'), genVisualizadorQrBtn = el('genVisualizadorQr');
    const finalizarBtn = el('finalizarSessao'), downloadAllBtn = el('downloadAllBtn'), printBtn = el('printBtn');
    const debugBtn = el('debugBtn');

    let currentSession = null;
    let currentViewerSession = null;
    let lastPhotos = [];

    function log(msg){
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function updateConnectionStatus(connected) {
      if (connected) {
        connectionStatusEl.innerHTML = 'üü¢ Conectado ao Servidor';
        connectionStatusEl.className = 'status connected';
      } else {
        connectionStatusEl.innerHTML = 'üî¥ Desconectado';
        connectionStatusEl.className = 'status disconnected';
      }
    }

    // Eventos de conex√£o Socket.IO
    socket.on('connect', () => {
      log('‚úÖ CONECTADO ao servidor: ' + SERVER_URL);
      updateConnectionStatus(true);
      
      // Se j√° temos uma sess√£o, rejoinar a sala
      if (currentSession) {
        socket.emit('join_room', { session: currentSession });
        log('Rejoined room: ' + currentSession);
      }
    });

    socket.on('disconnect', (reason) => {
      log('‚ùå DESCONECTADO: ' + reason);
      updateConnectionStatus(false);
    });

    socket.on('connect_error', (error) => {
      log('‚ùå ERRO de conex√£o: ' + error.message);
      updateConnectionStatus(false);
      console.error('Socket.IO error:', error);
    });

    // Criar sess√£o CELULAR automaticamente ao carregar a p√°gina
    window.addEventListener('DOMContentLoaded', () => {
      log('üîÑ Iniciando cria√ß√£o autom√°tica de sess√£o CELULAR...');
      socket.emit('create_session');
    });

    // Debug button
    debugBtn.addEventListener('click', () => {
      log('üêõ DEBUG - Estado atual:');
      log('- Sess√£o: ' + currentSession);
      log('- Socket conectado: ' + socket.connected);
      log('- Socket ID: ' + socket.id);
      
      // Testar health do servidor
      fetch(SERVER_URL + '/health')
        .then(r => r.json())
        .then(data => {
          log('ü©∫ Health check OK: ' + JSON.stringify(data));
        })
        .catch(e => {
          log('‚ùå Health check FALHOU: ' + e.message);
        });
    });

    // Resto do c√≥digo permanece igual...
    // [Manter todo o resto do c√≥digo do index.html anterior]

    // Gerar QR Code do Celular (apenas para regenerar)
    genQrBtn.addEventListener('click', ()=> {
      if (!currentSession) {
        log('Aguarde, criando sess√£o...');
        return;
      }
      generateQrCode();
    });

    // Gerar QR Code do Visualizador + Upload IMGBB (fotos + moldura)
    genVisualizadorQrBtn.addEventListener('click', () => {
      if (!currentSession || lastPhotos.length === 0) {
        log('‚ùå Nenhuma foto dispon√≠vel para gerar visualizador');
        return;
      }
      
      // Obter a moldura do stories
      const storiesMontage = storiesCanvas.toDataURL('image/jpeg', 0.92);
      
      log('üîÑ Criando sess√£o do visualizador e enviando para IMGBB...');
      genVisualizadorQrBtn.disabled = true;
      genVisualizadorQrBtn.textContent = 'Enviando...';
      
      socket.emit('create_viewer_session', { 
        session: currentSession, 
        photos: lastPhotos,
        storiesMontage: storiesMontage
      });
    });

    function generateQrCode() {
      qrcodeEl.innerHTML = '';
      const url = `${SERVER_URL}/celular.html?session=${encodeURIComponent(currentSession)}`;
      const canvas = document.createElement('canvas');
      QRCode.toCanvas(canvas, url, { width: 220 }, (err) => {
        if (err) { console.error(err); return; }
      });
      qrcodeEl.appendChild(canvas);
      log('üì± QR Code Celular gerado para: ' + currentSession);
    }

    function generateVisualizadorQrCode(viewerId) {
      qrcodeVisualizadorEl.innerHTML = '';
      const url = `${SERVER_URL}/visualizador.html?viewerId=${encodeURIComponent(viewerId)}`;
      const canvas = document.createElement('canvas');
      QRCode.toCanvas(canvas, url, { width: 220 }, (err) => {
        if (err) { console.error(err); return; }
      });
      qrcodeVisualizadorEl.appendChild(canvas);
      
      viewerSessionIdEl.textContent = viewerId;
      viewerInfoEl.style.display = 'block';
      
      log('üëÄ QR Code Visualizador gerado: ' + viewerId);
      log('‚úÖ Fotos e moldura enviadas para IMGBB!');
    }

    // Sess√£o CELULAR criada
    socket.on('session_created', (id) => {
      currentSession = id;
      sessionIdEl.textContent = id;
      
      // Gerar QR code do celular automaticamente
      generateQrCode();
      
      log('‚úÖ Sess√£o CELULAR criada: ' + id);
      genQrBtn.disabled = false;
      finalizarBtn.disabled = false;
      
      // Entrar na sala
      socket.emit('join_room', { session: id });
    });

    // Sess√£o VISUALIZADOR criada
    socket.on('viewer_session_created', ({ viewerId }) => {
      currentViewerSession = viewerId;
      generateVisualizadorQrCode(viewerId);
      genVisualizadorQrBtn.disabled = false;
      genVisualizadorQrBtn.textContent = 'Gerar QR Visualizador + IMGBB';
    });

    // Erro no visualizador
    socket.on('viewer_session_error', ({ error }) => {
      log('‚ùå Erro ao criar visualizador: ' + error);
      genVisualizadorQrBtn.disabled = false;
      genVisualizadorQrBtn.textContent = 'Gerar QR Visualizador + IMGBB';
    });

    // Fotos recebidas do celular
    socket.on('photos_ready', (photos) => {
      log(`üì∏ FOTOS RECEBIDAS: ${photos.length} fotos`);
      
      if (!Array.isArray(photos)) {
        log('‚ùå Fotos n√£o s√£o um array');
        return;
      }
      
      lastPhotos = photos.slice(0, 3);
      renderThumbs();
      drawStories(lastPhotos);
      drawPrint(lastPhotos);
      downloadAllBtn.disabled = false;
      printBtn.disabled = false;
      genVisualizadorQrBtn.disabled = false;
      
      log('‚úÖ Fotos renderizadas com sucesso');
    });

    // Finalizar sess√£o (limpa TUDO)
    finalizarBtn.addEventListener('click', () => {
      if (!currentSession) return alert('Nenhuma sess√£o ativa.');
      
      socket.emit('end_session', currentSession);
      
      // Limpar TUDO localmente
      thumbsEl.innerHTML = '';
      lastPhotos = [];
      downloadAllBtn.disabled = true;
      printBtn.disabled = true;
      genVisualizadorQrBtn.disabled = true;
      
      // Limpar visualizador anterior
      qrcodeVisualizadorEl.innerHTML = '';
      viewerInfoEl.style.display = 'none';
      currentViewerSession = null;
      
      // LIMPAR PREVIEWS - IMPORTANTE!
      const storiesCtx = storiesCanvas.getContext('2d');
      storiesCtx.clearRect(0, 0, storiesCanvas.width, storiesCanvas.height);
      
      const printCtx = printCanvas.getContext('2d');
      printCtx.clearRect(0, 0, printCanvas.width, printCanvas.height);
      
      log('üßπ Sess√£o finalizada - Pr√≥xima sess√£o com MESMA sess√£o: ' + currentSession);
    });

    // Download de todas as fotos
    downloadAllBtn.addEventListener('click', () => {
      if (!lastPhotos.length) return alert('Nenhuma foto para download.');
      
      lastPhotos.forEach((photo, index) => {
        const link = document.createElement('a');
        link.download = `foto-${currentSession}-${index + 1}.jpg`;
        link.href = photo;
        link.click();
      });
      
      log('üì• Download de todas as fotos iniciado');
    });

    function renderThumbs(){
      thumbsEl.innerHTML = '';
      lastPhotos.forEach((p, idx) => {
        const container = document.createElement('div');
        container.style.position = 'relative';
        container.style.display = 'inline-block';
        container.style.margin = '10px';
        
        const img = document.createElement('img');
        img.src = p;
        img.alt = 'foto-' + (idx+1);
        
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = 'üì• Download';
        downloadBtn.className = 'download-btn';
        downloadBtn.onclick = () => {
          const link = document.createElement('a');
          link.download = `foto-${currentSession}-${idx + 1}.jpg`;
          link.href = p;
          link.click();
        };
        
        container.appendChild(img);
        container.appendChild(downloadBtn);
        thumbsEl.appendChild(container);
      });
    }

    function drawImageCover(ctx, img, x, y, w, h){
      const imgRatio = img.width / img.height;
      const boxRatio = w / h;
      let sx=0, sy=0, sw=img.width, sh=img.height;
      if (imgRatio > boxRatio) {
        sw = img.height * boxRatio;
        sx = (img.width - sw) / 2;
      } else {
        sh = img.width / boxRatio;
        sy = (img.height - sh) / 2;
      }
      ctx.drawImage(img, sx, sy, sw, sh, x, y, w, h);
    }

    function drawStories(photos){
      const ctx = storiesCanvas.getContext('2d');
      ctx.clearRect(0,0,storiesCanvas.width, storiesCanvas.height);
      const bg = new Image();
      bg.src = 'caralho.png';
      bg.onload = () => {
        ctx.drawImage(bg, 0, 0, storiesCanvas.width, storiesCanvas.height);
        photos.forEach((p, i) => {
          const img = new Image();
          img.src = p;
          img.onload = () => {
            const c = STORIES_COORDS[i];
            if (!c) return;
            drawImageCover(ctx, img, c.x, c.y, c.w, c.h);
          };
        });
      };
    }

    function drawPrint(photos){
      const ctx = printCanvas.getContext('2d');
      ctx.clearRect(0,0,printCanvas.width, printCanvas.height);
      const bg = new Image();
      bg.src = 'imprimir.png';
      bg.onload = () => {
        ctx.drawImage(bg, 0, 0, printCanvas.width, printCanvas.height);
        photos.forEach((p, i) => {
          const img = new Image(); img.src = p;
          img.onload = () => {
            const c = PRINT_COORDS[i]; if (!c) return;
            drawImageCover(ctx, img, c.x, c.y, c.w, c.h);
          };
        });
      };
    }

    printBtn.addEventListener('click', () => {
      if (!lastPhotos.length) return alert('Nenhuma foto.');
      const data = printCanvas.toDataURL('image/png');
      const w = window.open('');
      w.document.write('<img src="'+data+'" style="max-width:100%;">');
      w.document.close();
      setTimeout(()=> w.print(), 700);
    });
  </script>
</body>
</html>
