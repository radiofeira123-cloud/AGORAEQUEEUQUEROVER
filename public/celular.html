<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Cabine Fotogr√°fica - Celular</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="fullscreenDiv">
    <button id="fsBtn">Entrar em tela cheia</button>
  </div>
  <div id="main" style="display:none;">
    <button id="startBtn">Clique aqui para iniciar</button>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="msg"></div>
  </div>
  <audio id="clickSound" src="clack.mp3"></audio>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const session = urlParams.get("session");
    const socket = io();
    socket.emit('join_room', { session });

    let photos = [];
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let msg = document.getElementById('msg');

    document.getElementById('fsBtn').onclick = () => {
      document.documentElement.requestFullscreen();
      document.getElementById('fullscreenDiv').style.display="none";
      document.getElementById('main').style.display="block";
    };

    document.getElementById('startBtn').onclick = startSession;

    async function startSession(){
      photos = [];
      msg.innerText = "";
      document.getElementById('startBtn').style.display="none";

      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;

      for (let i=0; i<3; i++){
        await countdown(5);
        takePhoto();
        await delay(3000);
      }

      msg.innerText = "Obrigado por utilizar a cabine!";
      socket.emit('photos_from_cell', { session, photos });
    }

    async function countdown(s){
      for(let i=s;i>0;i--){
        msg.innerText = (i<=2 ? "SORRIA" : i);
        if (i<=2) document.getElementById('clickSound').play();
        await delay(1000);
      }
    }

    function takePhoto(){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0);
      const data = canvas.toDataURL('image/jpeg');
      photos.push(data);
      msg.innerText = "Foto tirada!";
    }

    function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

    socket.on('end_session', () => {
      msg.innerText = "";
      document.getElementById('startBtn').style.display="block";
    });
  </script>
</body>
</html>
