<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cabine Fotográfica - Celular</title>
  <style>
    body { text-align:center; font-family:Arial; }
    #camera { display:none; width:100%; max-width:400px; }
    #countdown, #message { font-size: 2em; margin: 10px; }
  </style>
</head>
<body>
  <button id="fullscreenBtn">Entrar em Tela Cheia</button>
  <h2 id="startText">Clique aqui para iniciar</h2>
  <video id="camera" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="countdown"></div>
  <div id="message"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const session = urlParams.get("session");

    const socket = io("https://agoraequeeuquerover.onrender.com", {
      transports: ["websocket", "polling"]
    });

    let photos = [];

    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const countdown = document.getElementById("countdown");
    const message = document.getElementById("message");

    document.getElementById("fullscreenBtn").onclick = () => {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      }
      document.getElementById("fullscreenBtn").style.display = "none";
    };

    document.getElementById("startText").onclick = async () => {
      photos = [];
      document.getElementById("startText").style.display = "none";
      video.style.display = "block";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        video.srcObject = stream;
        takePhotos();
      } catch (err) {
        alert("Erro ao acessar câmera: " + err);
      }
    };

    async function takePhotos() {
      for (let i = 0; i < 3; i++) {
        await runCountdown();
        const photo = capturePhoto();
        photos.push(photo);
        await freezeFrame(photo);
      }
      message.innerText = "Obrigado por utilizar a cabine!";
      video.style.display = "none";
      socket.emit("photos_from_cell", { session, photos });
    }

    function runCountdown() {
      return new Promise((resolve) => {
        let time = 5;
        countdown.innerText = time;
        const interval = setInterval(() => {
          time--;
          if (time > 0) {
            countdown.innerText = time;
            if (time === 2) {
              message.innerText = "Sorria!";
              new Audio("clack.mp3").play();
            }
          } else {
            clearInterval(interval);
            countdown.innerText = "";
            message.innerText = "";
            resolve();
          }
        }, 1000);
      });
    }

    function capturePhoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      return canvas.toDataURL("image/png");
    }

    function freezeFrame(photo) {
      return new Promise((resolve) => {
        const img = document.createElement("img");
        img.src = photo;
        img.style.width = "100%";
        document.body.appendChild(img);
        setTimeout(() => {
          img.remove();
          resolve();
        }, 3000);
      });
    }

    socket.emit("join_session", session);

    socket.on("session_ended", () => {
      photos = [];
      message.innerText = "";
      countdown.innerText = "";
      video.style.display = "none";
      document.getElementById("startText").style.display = "block";
    });
  </script>
</body>
</html>
