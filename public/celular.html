<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cabine Fotogr√°fica</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#000; color:#fff; text-align:center; }
    video, canvas { width:100vw; height:100vh; object-fit:cover; display:none; }
    #overlay {
      position:fixed; top:20%; left:50%; transform:translateX(-50%);
      font-size:48px; font-weight:bold; text-shadow:2px 2px 5px #000;
    }
    #controls { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:9999; }
    button { padding:10px 20px; font-size:18px; }
  </style>
</head>
<body>
  <div id="overlay">Bem-vindo √† cabine fotogr√°fica</div>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="controls">
    <button id="btnFullscreen">üì± Entrar em Tela Cheia</button>
    <button id="btnStart" style="display:none;">Clique aqui para come√ßar</button>
  </div>
  <audio id="clickSound" src="click.mp3"></audio>

  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const session = urlParams.get("session");

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const overlay = document.getElementById("overlay");
    const btnFullscreen = document.getElementById("btnFullscreen");
    const btnStart = document.getElementById("btnStart");
    const clickSound = document.getElementById("clickSound");

    socket.emit("join_session", session);

    btnFullscreen.onclick = () => {
      let el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();

      btnFullscreen.style.display = "none";
      btnStart.style.display = "inline-block";
    };

    btnStart.onclick = async () => {
      btnStart.style.display = "none";
      overlay.innerText = "Preparando c√¢mera...";

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" }
        });
        video.srcObject = stream;
        video.style.display = "block";
        overlay.innerText = "";
        await new Promise(r => setTimeout(r, 1000));
        takePhotos();
      } catch (err) {
        overlay.innerText = "Erro ao acessar a c√¢mera!";
      }
    };

    async function takePhotos() {
      let photos = [];
      const ctx = canvas.getContext("2d");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      for (let i = 0; i < 3; i++) {
        for (let t = 5; t > 0; t--) {
          overlay.innerText = (t <= 2 ? "Sorria!" : t);
          if (t === 2) clickSound.play();
          await new Promise(r => setTimeout(r, 1000));
        }

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
        photos.push(dataUrl);

        video.style.display = "none";
        canvas.style.display = "block";
        overlay.innerText = "";
        await new Promise(r => setTimeout(r, 3000));

        if (i < 2) {
          video.style.display = "block";
          canvas.style.display = "none";
        }
      }

      video.style.display = "none";
      canvas.style.display = "none";
      overlay.innerText = "Obrigado por utilizar a cabine!";
      socket.emit("photos_from_cell", { session, photos });
    }

    socket.on("session_ended", () => {
      location.reload();
    });
  </script>
</body>
</html>
